<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Doğrulama - Türkel Admin</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    .logo {
      width: 120px;
      height: 60px;
      background: #CE1A28;
      margin: 0 auto 1.5rem;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }
    h1 {
      color: #333;
      margin-bottom: 1rem;
      font-size: 24px;
    }
    p {
      color: #666;
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #CE1A28;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      background: #fee;
      border: 1px solid #fcc;
      padding: 1rem;
      border-radius: 6px;
      color: #c00;
      margin-top: 1rem;
    }
    .success {
      background: #efe;
      border: 1px solid #cfc;
      padding: 1rem;
      border-radius: 6px;
      color: #060;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">TÜRKEL</div>
    <h1>Email Doğrulama</h1>
    <p id="status">
      <span class="loading"></span>
      Email adresiniz doğrulanıyor...
    </p>
    <div id="message"></div>
  </div>

  <script>
    if (window.netlifyIdentity) {
      // Handle the confirmation
      window.netlifyIdentity.on("init", user => {
        console.log("Identity init, user:", user);
        
        // Check if we have a confirmation token in URL
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const token = urlParams.get('confirmation_token') || urlParams.get('invite_token') || urlParams.get('recovery_token');
        
        if (token) {
          console.log("Token found:", token.substring(0, 10) + "...");
          document.getElementById('status').innerHTML = '<span class="loading"></span>Email doğrulanıyor...';
          
          // Auto-confirm the user
          window.netlifyIdentity.confirm(token, true)
            .then(user => {
              console.log("Confirmation successful:", user);
              document.getElementById('status').textContent = 'Email başarıyla doğrulandı!';
              document.getElementById('message').innerHTML = '<div class="success">Hesabınız aktifleştirildi. Şimdi giriş yapabilirsiniz.</div>';
              
              // Redirect to admin after 2 seconds
              setTimeout(() => {
                window.location.href = '/admin/';
              }, 2000);
            })
            .catch(error => {
              console.error("Confirmation failed:", error);
              document.getElementById('status').textContent = 'Doğrulama hatası!';
              document.getElementById('message').innerHTML = '<div class="error">Email doğrulanırken hata oluştu: ' + error.message + '</div>';
            });
        } else {
          document.getElementById('status').textContent = 'Token bulunamadı!';
          document.getElementById('message').innerHTML = '<div class="error">Doğrulama token\'ı bulunamadı. Lütfen email\'inizdeki linki tekrar kontrol edin.</div>';
        }
      });

      window.netlifyIdentity.on("login", user => {
        console.log("User logged in:", user);
        window.location.href = '/admin/';
      });

      window.netlifyIdentity.on("error", err => {
        console.error("Identity error:", err);
        document.getElementById('status').textContent = 'Hata oluştu!';
        document.getElementById('message').innerHTML = '<div class="error">' + err.message + '</div>';
      });
    } else {
      document.getElementById('status').textContent = 'Identity yüklenemedi!';
      document.getElementById('message').innerHTML = '<div class="error">Netlify Identity yüklenemedi. Lütfen sayfayı yenileyin.</div>';
    }
  </script>
</body>
</html>
